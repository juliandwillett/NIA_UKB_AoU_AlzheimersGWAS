# Get necessary programs
wget https://github.com/rgcgithub/regenie/releases/download/v3.2.8/regenie_v3.2.8.gz_x86_64_Linux.zip ;\
unzip regenie_v3.2.8.gz_x86_64_Linux.zip ;\
wget https://s3.amazonaws.com/plink2-assets/alpha3/plink2_linux_avx2_20221024.zip ;\
unzip plink2_linux_avx2_20221024.zip

gsutil -m cp -rn $WORKSPACE_BUCKET/data/rg_results_all_anc_all_var_mac_20/*AD_any.regenie .
mv aou_step2_rg_chr1_common_anc_all_AD_any.regenie aou_step2_rg_chr1_allvar_anc_all_AD_any.regenie # naming error

# R code
library(glue); library(tidyverse) ; library(vroom)
for (i in 1:22) {
    print(glue("On chr {i}"))
    gw = vroom(glue("aou_step2_rg_chr{i}_allvar_anc_all_AD_any.regenie")) %>% 
    mutate(ID = glue("{CHROM}-{GENPOS}-{ALLELE0}-{ALLELE1}"))
    favor = read.table("favor_hits.txt")
    df = gw %>% filter(LOG10P >= 7.30102999566398 | ID %in% favor$V1)
    filter_df = data.frame(CHROM=df$CHROM,POSSTART=df$GENPOS,POSSTOP=df$GENPOS)
    vroom_write(filter_df,glue("sig_variants_chr{i}.txt"),col_names=F)
}

# bash code
curr_chr=22
gsutil -m cp -rn $WORKSPACE_BUCKET/data/regenie_pheno.txt .
gsutil -m cp -rn $WORKSPACE_BUCKET/data/regenie_covar.txt .
gsutil -m cp -rn $WORKSPACE_BUCKET/data/regenie/* .
mkdir out

gsutil -m cp -rn $WORKSPACE_BUCKET/data/pgen_minimal_qc/plink_chr${curr_chr}_* . ;\

if ((curr_chr>=17)) ; then
    ./plink2 --pfile plink_chr${curr_chr}_multi_split \
        --geno 0.1 --hwe 1e-15 \
        --make-pgen --out tmp \
        --extract bed1 sig_variants_chr${curr_chr}.txt
else
    ./plink2 --pfile plink_chr${curr_chr}_multi_split_merged \
        --geno 0.1 --hwe 1e-15 \
        --make-pgen --out tmp \
        --extract bed1 sig_variants_chr${curr_chr}.txt
fi

# revise psam file given the empty column being dropped
awk 'NR==1 {print "#FID\tIID\tSEX"} NR>1 {print "0\t" $1 "\t" "NA"}' tmp.psam > t ;\
mv t tmp.psam ;

awk '{gsub("duplicateofalzheimersgwastake5", "duplicateofalzheimersgwastake5", $2)} 1' aou_step1_rg_array_anc_all_pred.list > revised_pred.list

./regenie_v3.2.8.gz_x86_64_Linux \
    --step 2 \
    --pgen tmp \
    --phenoFile regenie_pheno.txt \
    --covarFile regenie_covar.txt \
    --qt --force-qt --mcc --firth-se \
    --firth --approx --pThresh 0.01 \
    --pred revised_pred.list --ignore-pred \
    --bsize 400 \
    --out out/sig_hits_qt_mcc_chr${curr_chr} \
    --minMAC 20 \
    --phenoCol AD_any  

./regenie_v3.2.8.gz_x86_64_Linux \
    --step 2 \
    --pgen tmp \
    --phenoFile regenie_pheno.txt \
    --covarFile regenie_covar.txt \
    --qt --force-qt --firth-se \
    --firth --approx --pThresh 0.01 \
    --pred revised_pred.list --ignore-pred \
    --bsize 400 \
    --out out/sig_hits_qt_nomcc_chr${curr_chr} \
    --minMAC 20 \
    --phenoCol AD_any ;

./regenie_v3.2.8.gz_x86_64_Linux \
    --step 2 \
    --pgen tmp \
    --phenoFile regenie_pheno.txt \
    --covarFile regenie_covar.txt \
    --bt --firth-se \
    --firth --approx --pThresh 0.01 \
    --pred revised_pred.list \
    --bsize 400 \
    --out out/sig_hits_bt_chr${curr_chr} \
    --minMAC 20 \
    --phenoCol AD_any

# an alternative for getting the firth SE (if this parameter was forgotten, but firth option still selected) in R
gwas = vroom("/n/home09/jwillett/true_lab_storage/Data_Links/AoU_GWAS/NON_MCC_GWAS/aou_AD_any_anc_all_gwas_pvals_ids_chrompos.txt")
gwas %<>% mutate(SE = abs(BETA/ qnorm(Pval/2)))
vroom_write(gwas,"/n/home09/jwillett/true_lab_storage/Data_Links/AoU_GWAS/NON_MCC_GWAS/aou_AD_any_anc_all_gwas_pvals_ids_chrompos_firthse.txt")

##########
# Merge the results
head -n 1 sig_hits_bt_chr17_AD_any.regenie > bt_hits.txt ;\
head -n 1 sig_hits_bt_chr17_AD_any.regenie > qt_mcc_hits.txt ;\
head -n 1 sig_hits_bt_chr17_AD_any.regenie > qt_nomcc_hits.txt

for ((i=17;i<=22;i++)); do
    tail -n +2 "sig_hits_bt_chr${i}_AD_any.regenie" >> bt_hits.txt
    tail -n +2 "sig_hits_qt_mcc_chr${i}_AD_any.regenie" >> qt_mcc_hits.txt
    tail -n +2 "sig_hits_qt_nomcc_chr${i}_AD_any.regenie" >> qt_nomcc_hits.txt
done

#########
# Use R to focus on variants we care about/are testing
df_bt = vroom("out/bt_hits.txt",show_col_types = FALSE)
df_qt_mcc = vroom("out/qt_mcc_hits.txt",show_col_types = FALSE)
df_qt_nomcc = vroom("out/qt_nomcc_hits.txt",show_col_types = FALSE)

all_ids = character()
for (i in 1:22) {
    print(glue("On chr {i}"))
    gw = vroom(glue("aou_step2_rg_chr{i}_allvar_anc_all_AD_any.regenie"),show_col_types = FALSE) %>% 
    mutate(ID = glue("{CHROM}-{GENPOS}-{ALLELE0}-{ALLELE1}"))
    favor = read.table("favor_hits.txt")
    df = gw %>% filter(LOG10P >= 7.30102999566398 | ID %in% favor$V1) %>%
        mutate(ID = glue("{CHROM}:{GENPOS}:{ALLELE0},{ALLELE1}"))
    all_ids %<>% append(df$ID)
}

df_bt %<>% filter(ID %in% all_ids,A1FREQ * N >= 20)
df_qt_mcc %<>% filter(ID %in% all_ids,A1FREQ * N >= 20)
df_qt_nomcc %<>% filter(ID %in% all_ids,A1FREQ * N >= 20)

vroom_write(df_bt,"bt_hits_firthse.txt")
vroom_write(df_qt_mcc,"qt_mcc_hits_firthse.txt")
vroom_write(df_qt_nomcc,"qt_nomcc_hits_firthse.txt")
